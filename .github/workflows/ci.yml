name: Build-Test-Deploy

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Windows-compatible CLEANUP using PowerShell
      # --------------------------------------------------
      - name: Remove Old Containers
        shell: powershell
        run: |
          Write-Host "Removing old containers..."

          $containers = docker ps -a --format "{{.Names}}"
          foreach ($c in $containers) {
            if ($c -in @("rto-mongo", "rto-backend", "rto-frontend")) {
              Write-Host "Removing container: $c"
              docker rm -f $c
            }
          }

          Write-Host "Pruning unused containers..."
          docker container prune -f

      - name: Cleanup Networks & Volumes
        shell: powershell
        run: |
          Write-Host "Pruning networks..."
          docker network prune -f

          Write-Host "Pruning volumes..."
          docker volume prune -f

      # --------------------------------------------------
      # FRONTEND INSTALL + TESTS
      # --------------------------------------------------
      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm install

      - name: Run Frontend Tests
        working-directory: frontend
        run: npm test --if-present

      # --------------------------------------------------
      # BACKEND INSTALL + TESTS
      # --------------------------------------------------
      - name: Install Backend Dependencies
        working-directory: backend
        run: npm install

      - name: Run Backend Tests
        working-directory: backend
        run: npm test --if-present

      # --------------------------------------------------
      # DEPLOYMENT (DOCKER COMPOSE)
      # --------------------------------------------------
      - name: Docker Compose Down
        shell: powershell
        run: |
          docker compose down
        continue-on-error: true # prevent failure if nothing is running

      - name: Docker Compose Up (Build & Deploy)
        shell: powershell
        run: docker compose up -d --build

      - name: Check Running Containers
        run: docker ps -a
